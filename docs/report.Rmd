---
title: |
  ![](flomics_icon.png){width=3in}
  <p style="color:#00AEEF">________________________________________________________</p>

  <p style="color:#00AEEF">**RNAseq report from `r sample`**</p>
date: <h4 style="font-style:normal"><p style="color:#00AEEF">`r Sys.Date()`</p></h4><br />
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
keep_md: true
sample: "`r sample`"
single_end: "`r single_end`"
genome: "` r genome`"
gtf: "`r gtf`"
gencode: "`r gencode`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(OpenImageR)
library(kableExtra)
```

# <font size="5"><span style="color: #00AEEF;">**Parameters**</span></font>

```{r echo = FALSE}
if (genome != "") {
  parameters <- data.frame(parameter = c("Genome version", "Annotation version (Ensembl)", "Gencode version"), Value = c(genome, gtf, gencode))
  kable(parameters, align = 'l') %>%
    kable_styling(full_width = F) %>%
    column_spec(1, width = "50em") %>%
    column_spec(2, width = "30em")
}
#parameters <- data.frame(parameter = c("Protocol", "Kit", "Allele frequency threshold (VC iVar)", "Minimum base quality (VC iVar)", "Minimum coverage (VC iVar)"), Value = c(protocol, kit, threshold, min_base_qual, min_coverage))
#kable(parameters, align = 'l') %>%
#  kable_styling(full_width = F) %>%
#  column_spec(1, width = "50em") %>%
#  column_spec(2, width = "30em")
```

#  <br /><font size="5"><span style="color: #00AEEF;">**Number of reads**</span></font>

```{r echo = FALSE}
tabseq <- paste("fastqc/", sample, "_total_sequences.txt", sep = "")
seqpath <- file.path(getwd(), tabseq)
if (file.exists(seqpath)){
  seqs <- read.table(seqpath, stringsAsFactors = FALSE, sep = "\t")
  seqs[,1] <- gsub(" .+", "", seqs[,1])
  if (single_end == "paired") {
    total <- data.frame(sample_name = c("R1", "R2"), Sequences = c(as.numeric(seqs[2,1])/4, as.numeric(seqs[2,2])/4))
    colnames(total)[1] <- sample
  } else {
    total <- data.frame(sample_name = c("single_end"), Sequences = c(as.numeric(seqs[1,1]))/4)
    colnames(total)[1] <- sample
  }
  kable(total) %>%
    kable_styling(full_width = F) %>%
    column_spec(1, width = "50em") %>%
    column_spec(2, width = "30em")
} else {
  message ("Step fastqc was skipped")
}
```


#  <br /><font size="5"><span style="color: #00AEEF;">**Number of trimmed reads**</span></font>

```{r echo = FALSE}
tabtrim <- paste("trim_galore/", sample, "_after_trimming_sequences.txt", sep = "")
path <- file.path(getwd(), tabtrim)
if (file.exists(path)){
  trimmed <- read.table(path, sep = "\t", stringsAsFactors = FALSE)
  trimmed$V2 <- gsub(".f.+q.gz","",trimmed$V2,ignore.case=T)
  trimmed$V1 <- gsub("Filename","Sample",trimmed$V1,ignore.case=T)
  numseqfile <- paste("trim_galore/", sample, "_number_sequences.txt", sep = "")
  numseqpath <- file.path(getwd(), numseqfile)
  numseq <- read.table(numseqpath, stringsAsFactors = FALSE, sep = "\t")
  if (single_end == "paired") {
    trim <- data.frame(sample_name = c("R1", "R2"), Discarded_reads = c(as.numeric(numseq[1,1])/4-as.numeric(trimmed[2,2]), as.numeric(numseq[2,1])/4-as.numeric(trimmed[4,2])))
    colnames(trim)[1] <- sample
  } else {
    trim <- data.frame(sample_name = c("single_end"), Discarded_reads = c(as.numeric(numseq[1,1])/4-as.numeric(trimmed[2,2])))
    colnames(trim)[1] <- sample
  }
  kable(trim, align = "l") %>%
    kable_styling(full_width = F) %>%
    column_spec(1, width = "50em") %>%
    column_spec(2, width = "30em")
} else {
  message ("Step for adapter trimming has been skipped")
}

```


# <font size="5"><span style="color: #00AEEF;">**Number of mapped reads**</span></font>

```{r echo = FALSE}
if (single_end == "paired") {
  mapfile <- paste("star/", sample, "_1Log.final.out", sep = "")
} else {
  mapfile <- paste("star/", sample, "Log.final.out", sep = "")
}
mappath <- file.path(getwd(), mapfile)
if (file.exists(mappath)){
  mapped <- read.table(mappath, stringsAsFactors = FALSE, sep = "\\")
  input <- as.numeric(gsub("[A-Za-z]+|\t|\\|| ", "", mapped[5,]))
  mapped <- as.numeric(gsub("[A-Za-z]+|\t|\\|| ", "", mapped[8,])) + as.numeric(gsub("[A-Za-z]+|\t|\\|| ", "", mapped[23,])) + as.numeric(gsub("[A-Za-z]+|\t|\\|| ", "", mapped[25,]))
  mapped_percentage <- mapped/input * 100
  if (single_end == "paired") {
    total_reads <- input*2
    mapped_reads <- mapped*2
  } else {
    total_reads <- input
    mapped_reads <- mapped
  }
  mapped_percentage <- round(mapped_reads/total_reads, 2)
  maptab <- data.frame(names = c("Total reads for mapping", "%mapped reads", "mapped reads"), Values = c(total_reads, mapped_percentage, mapped_reads))
  kable(maptab, row.names = NA, col.names = c("", "value"))  %>%
    kable_styling(full_width = F) %>%
    column_spec(1, width = "50em") %>%
    column_spec(2, width = "30em")
} else {
  message("Mapping step has been skipped")
}

```


# <br /><font size="5"><span style="color: #00AEEF;">**Transcript coverage profile**</span></font>

```{r echo = FALSE}
file <- paste("qualimap/", sample, ".coverage.txt", sep = "")
coverage <- read.table(file, header = FALSE, stringsAsFactors = FALSE)
coverage.df <- data.frame(bias = coverage$V1, value = coverage$V4)
kable(coverage.df, row.names = NA, col.names = c("Bias", "Value")) %>%
  kable_styling(full_width = F) %>%
  column_spec(1, width = "50em") %>%
  column_spec(2, width = "30em")
```

```{r echo = FALSE}
#Image
im_file <- paste("qualimap/", sample, ".genome_coverage_across_reference.png", sep = "")
path <- file.path(getwd(), im_file)
im <- readImage(path)
imageShow(im)
```


# <br /><font size="4"><span style="color: #00AEEF;">**Number of variants**</span></font>

```{r echo = FALSE}

```

# <br /><font size="4"><span style="color: #00AEEF;">**Variants interpretation**</span></font>

```{r echo = FALSE}
```



# <br /><font size="5"><span style="color: #00AEEF;">**Contact**</span></font>

<font sieze="3">If you have any question, please contact [**support@flomics.com**](mailto:support@flomics.com) </font>
